@page "/completedtasks"
@inject ISnackbar Snackbar
@inject ITaskApiService _taskApiService
@inject ITaskService _taskService
@inject IDialogService DialogService
@inject AppMessageState _appMessageState
@inject ICompletedTasksService _completedTasks

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large">

        <div style="display: flex; flex-direction: column;">
            <div style="display: flex; flex-direction:column; margin-top:30px;">
                @if (!tasks.Any())
                {
                    <MudElement HtmlTag="a" Style="color:red;font-weight:bold;">Tamamlanan görev bulunmuyor.</MudElement>
                }
                else
                {
                    <div style="display: flex; flex-direction:row; justify-content:end">
                        <MudElement HtmlTag="a" Style="color:black;font-weight:bold;">Görevler</MudElement>
                        <MudSpacer />
                        <MudButton Color="Color.Error" Disabled="@_isDeleteDisabled" OnClick="Delete">Sil</MudButton>
                    </div>
                    <MudDataGrid @ref="@Grid" Items="@tasks" T="TaskItemDTO" Style="margin-top: 20px; width: 100%" MultiSelection="true" ColumnResizeMode="ResizeMode.Column" SelectedItemsChanged="GridSelectionChanged">
                        <Columns>
                            <SelectColumn T="TaskItemDTO" ShowInHeader="false" />
                            <PropertyColumn Property="x => x.Title" Title="Başlık" />
                            <PropertyColumn Property="x => x.Description" Title="Açıklama" />
                            <PropertyColumn Property="x => x.PriorityName" Title="Öncelik" />
                            <PropertyColumn Property="x => x.TaskStateName" Title="Durumu" />
                            <PropertyColumn Property="x => x.DueDate" Title="Teslim Tarihi" Format="dd.MM.yyyy" />
                        </Columns>
                    </MudDataGrid>
                }
            </div>
        </div>
    </MudContainer>
}


@code {
    MudDataGrid<TaskItemDTO>? Grid;
    private IEnumerable<TaskItemDTO> tasks = new List<TaskItemDTO>();
    List<Guid> selectedRowsIds = [];
    private bool _isDeleteDisabled = true;
    private bool _isUpdateDisabled = true;
    private StateDto? selectedState { get; set; }
    private bool _isLoading = true;
    private TaskItemDTO? itemToUpdate { get; set; }
    private DateTime dateTime = DateTime.Today;

    protected override void OnInitialized()
    {
        _isLoading = true;
        try
        {
            tasks = _completedTasks.GetCompletedTasks();
            _isLoading = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
            _isLoading = false;
        }
    }

    void GridSelectionChanged(HashSet<TaskItemDTO> taskItems)
    {
        selectedRowsIds.Clear();
        foreach (var item in taskItems)
        {
            selectedRowsIds.Add(item.Id);
        }
        if (taskItems.Count == 1)
        {
            itemToUpdate = taskItems.ElementAt(0);
        }
        else
        {
            itemToUpdate = null;
        }
        _isUpdateDisabled = taskItems.Count() == 1 ? false : true;
        _isDeleteDisabled = taskItems.Count() > 0 ? false : true;
        StateHasChanged();
    }

    async Task Delete()
    {
        _isUpdateDisabled = true;
        _isDeleteDisabled = true;
        if (selectedRowsIds.Count() > 0)
        {
            if (selectedRowsIds.Count() == 1)
            {
                try
                {
                    var response = await _taskService.DeleteTaskAsync(selectedRowsIds[0]);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TaskTitle} başlıklı görev silindi.", Severity.Success);
                        tasks = _completedTasks.GetCompletedTasks();
                        Grid!.SelectedItems.Clear();
                    }
                    else
                    {
                        Snackbar.Add(response.Data?.ErrorMessage ?? response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
            else
            {
                try
                {
                    var response = await _taskService.BulkDeleteAsync(selectedRowsIds);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TotalDeleted} görev silindi.", Severity.Success);
                    }
                    else if (response.PartialSuccess)
                    {
                        string failedTitles = string.Join("\n• ", response.Data!.FailedTasks.Select(ft => ft.TaskTitle));
                        Snackbar.Add($"{response.Data.TotalDeleted} görev silindi, ancak {response.Data.FailedTasks.Count} görev silinemedi.\nSilinemeyen görevler:\n• {failedTitles}", Severity.Warning);
                    }
                    else
                    {
                        Snackbar.Add(response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }

                    if (response.Success || response.PartialSuccess)
                    {
                        tasks = _completedTasks.GetCompletedTasks();
                    }
                    Grid!.SelectedItems.Clear();
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
        }
        else
        {
            Snackbar.Add("Silinecek görev seçilmedi.", Severity.Warning);
        }
        _isDeleteDisabled = false;
        _isUpdateDisabled = false;
    }
}
