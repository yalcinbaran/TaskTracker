@page "/"
@inject IAuthService authService
@inject IUserSessionService _userSessionService
@inject NavigationManager _navManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small">
    <MudPaper Height="500px" Width="100%" Square="true" Style="margin-top:100px;">
        <MudTabs Centered="true">
            <MudTabPanel Text="Login">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%; margin-top:25px;">
                    <MudForm @ref="_loginForm" Model="_loginModel">
                        <MudTextField @bind-Value="_loginModel.Username" Label="Username" Required="true" />
                        <MudTextField @bind-Value="_loginModel.Password" Label="Password" InputType="InputType.Password" Required="true" />
                        <MudButton OnClick="SubmitLogin">Login</MudButton>
                    </MudForm>
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Register">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%; margin-top:25px;">
                    <MudForm @ref="_registerForm" Model="_registerModel">
                        <MudTextField @bind-Value="_registerModel.FirstName" T="string" Label="İsim" Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Text" Class="fields" />
                        <MudTextField @bind-Value=_registerModel.SurName T="string" Label="Soyisim" Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Text" Class="fields" />
                        <MudTextField @bind-Value="_registerModel.Email" T="string" Label="E-posta" Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Email" Class="fields" />
                        <MudTextField @bind-Value="_registerModel.Password" T="string" Label="Şifre" Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Password" Class="fields" />
                        <MudTextField @bind-Value="_registerModel.PasswordConfirm" T="string" Label="Şifre Tekrar" Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Password" Class="fields" />
                        <MudButton OnClick="SubmitRegister" Variant="Variant.Filled" Color="Color.Primary">Register</MudButton>
                    </MudForm>
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>

<style>
    .fields {
        width: 400px;
    }
</style>

@code {
    private MudForm? _loginForm;
    private MudForm? _registerForm;
    private LoginModel _loginModel = new();
    private RegisterModel _registerModel = new();

    private async Task SubmitLogin()
    {
        await _loginForm!.Validate();

        if (_loginForm.IsValid)
        {
            var result = await authService.LoginAsync<UserDTO>(_loginModel);

            if (result.Success && result.Data is not null)
            {
                _userSessionService.SetSession(result.Data);
                _navManager.NavigateTo("/dashboard");
                Snackbar.Add("Giriş başarılı!", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
    }

    private async Task SubmitRegister()
    {
        await _registerForm!.Validate();
        if (_registerForm.IsValid)
        {
            var result = await authService.RegisterAsync<UserDTO>(_registerModel);
            if (result.Success && result.Data is not null)
            {
                _userSessionService.SetSession(result.Data);
                _navManager.NavigateTo("/dashboard");
                Snackbar.Add("Kayıt başarılı!", Severity.Success);
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
    }
}
