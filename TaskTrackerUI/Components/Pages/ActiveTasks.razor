@page "/activetasks"
@inject ITaskService _taskService
@inject ISnackbar Snackbar
@inject ITaskApiService _taskApiService
@inject IDialogService DialogService
@inject IActiveTaskService _activeTasks
@inject IOverdueTasksService _overdueTasks
@inject ICompletedTasksService _completedTasks
@inject ICanceledTasksService _canceledTasks
@inject AppMessageState _appMessageState
@inject IStateAndPriorityService _stateAndPriorities
<PageTitle>Aktif Görevler</PageTitle>


@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large">

        <div style="display: flex; flex-direction: column; margin-top: 30px;">
            <MudSelect T="int" Label="Durum" Value="@selectedState!.Level" ValueChanged="StateSelectionChanged">
                @foreach (var state in States)
                {
                    <MudSelectItem Value="@state.Level">@state.Name</MudSelectItem>
                }
            </MudSelect>

            <div style="display: flex; flex-direction:column; margin-top:30px;">
                @if (!tasks.Any())
                {
                    <MudElement HtmlTag="a" Style="color:red;font-weight:bold;">@selectedState.Name durumunda görev bulunmuyor.</MudElement>
                }
                else
                {
                    <div style="display: flex; flex-direction:row; justify-content:end">
                        <MudElement HtmlTag="a" Style="color:black;font-weight:bold;">Görevler</MudElement>
                        <MudSpacer />
                        <MudButton Color="Color.Info" Disabled="@_isUpdateDisabled" OnClick="OpenUpdateDialog">Güncelle</MudButton>
                        <MudButton Color="Color.Error" Disabled="@_isDeleteDisabled" OnClick="Delete">Sil</MudButton>
                    </div>
                    <MudDataGrid @ref="@Grid" Items="@tasks" T="TaskItemDTO" Style="margin-top: 20px; width: 100%" MultiSelection="true" ColumnResizeMode="ResizeMode.Column" SelectedItemsChanged="GridSelectionChanged">
                        <Columns>
                            <SelectColumn T="TaskItemDTO" ShowInHeader="false" />
                            <PropertyColumn Property="x => x.Title" Title="Başlık" />
                            <PropertyColumn Property="x => x.Description" Title="Açıklama" />
                            <PropertyColumn Property="x => x.PriorityName" Title="Öncelik" />
                            <PropertyColumn Property="x => x.TaskStateName" Title="Durumu" />
                            <PropertyColumn Property="x => x.DueDate" Title="Teslim Tarihi" Format="dd.MM.yyyy" />
                        </Columns>
                    </MudDataGrid>
                }
            </div>
        </div>
    </MudContainer>
}


@code {
    [CascadingParameter]
    public UserSession UserSession { get; set; } = default!;
    MudDataGrid<TaskItemDTO>? Grid;
    private IEnumerable<StateDto> States = new List<StateDto>();
    private IEnumerable<PriorityDto> Priorities = new List<PriorityDto>();
    private IEnumerable<TaskItemDTO> tasks = new List<TaskItemDTO>();
    List<Guid> selectedRowsIds = [];
    private bool _isDeleteDisabled = true;
    private bool _isUpdateDisabled = true;
    private int stateLevel = 0;
    private StateDto? selectedState { get; set; }
    private bool _isLoading = true;
    private TaskItemDTO? itemToUpdate { get; set; }
    private DateTime dateTime = DateTime.Today;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(_appMessageState.SnackbarMessage))
        {
            Snackbar.Add(_appMessageState.SnackbarMessage, _appMessageState.SnackbarSeverity);
            _appMessageState.SnackbarMessage = null;
        }
        Priorities = _stateAndPriorities.GetPriorities();
        States = _stateAndPriorities.GetStates();
        States = States.Where(s => s.Level != 1 && s.Level != 4);
        States = States.Append(new StateDto { Level = 0, Name = "Tümü" });
        StateSelectionChanged(0);
    }

    void StateSelectionChanged(int level)
    {
        _isLoading = true;
        stateLevel = level;
        selectedState = States.Where<StateDto>(s => s.Level == level).FirstOrDefault();
        tasks = _activeTasks.GetActiveTasks();
        if (selectedState!.Name != "Tümü")
            tasks = tasks.Where(t => t.TaskStateName == selectedState!.Name);

        if (Grid != null)
            Grid.SelectedItems.Clear();
        selectedRowsIds.Clear();
        _isDeleteDisabled = true;
        _isLoading = false;
        StateHasChanged();
    }

    void GridSelectionChanged(HashSet<TaskItemDTO> taskItems)
    {
        selectedRowsIds.Clear();
        foreach (var item in taskItems)
        {
            selectedRowsIds.Add(item.Id);
        }
        if (taskItems.Count == 1)
        {
            itemToUpdate = taskItems.ElementAt(0);
        }
        else
        {
            itemToUpdate = null;
        }
        _isUpdateDisabled = taskItems.Count() == 1 ? false : true;
        _isDeleteDisabled = taskItems.Count() > 0 ? false : true;
        StateHasChanged();
    }

    async Task Delete()
    {
        _isUpdateDisabled = true;
        _isDeleteDisabled = true;
        if (selectedRowsIds.Count() > 0)
        {
            if (selectedRowsIds.Count() == 1)
            {
                try
                {
                    var response = await _taskService.DeleteTaskAsync(selectedRowsIds[0]);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TaskTitle} başlıklı görev silindi.", Severity.Success);
                        await _activeTasks.LoadActiveTasks(UserSession.UserId);
                        tasks = _activeTasks.GetActiveTasks();
                        Grid!.SelectedItems.Clear();
                    }
                    else
                    {
                        Snackbar.Add(response.Data?.ErrorMessage ?? response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
            else
            {
                try
                {
                    var response = await _taskService.BulkDeleteAsync(selectedRowsIds);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TotalDeleted} görev silindi.", Severity.Success);
                    }
                    else if (response.PartialSuccess)
                    {
                        string failedTitles = string.Join("\n• ", response.Data!.FailedTasks.Select(ft => ft.TaskTitle));
                        Snackbar.Add($"{response.Data.TotalDeleted} görev silindi, ancak {response.Data.FailedTasks.Count} görev silinemedi.\nSilinemeyen görevler:\n• {failedTitles}", Severity.Warning);
                    }
                    else
                    {
                        Snackbar.Add(response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }

                    if (response.Success || response.PartialSuccess)
                    {
                        await _activeTasks.LoadActiveTasks(UserSession.UserId);
                        tasks = _activeTasks.GetActiveTasks();
                    }
                    Grid!.SelectedItems.Clear();
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
        }
        else
        {
            Snackbar.Add("Silinecek görev seçilmedi.", Severity.Warning);
        }
        _isDeleteDisabled = false;
        _isUpdateDisabled = false;
    }

    private async Task OpenUpdateDialog()
    {
        var parameters = new DialogParameters { ["Task"] = itemToUpdate };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialogReference = await DialogService.ShowAsync<UpdateTaskDialog>("Görev Güncelle", parameters, options);
        var dialogResult = await dialogReference.Result;

        if (!dialogResult!.Canceled)
        {
            var result = dialogResult.Data as UpdateTaskDialogResult;

            if (result?.Response.Success == true)
            {
                Snackbar.Add("Görev başarıyla güncellendi.", Severity.Success);
                await _overdueTasks.LoadOverdueTasks(dateTime, UserSession.UserId);
                switch (result.TaskStateLevel)
                {
                    case 1: // İptal edilen
                        await _canceledTasks.LoadCanceledTasks(UserSession.UserId);
                        break;
                    case 2: // Beklemede
                        await _activeTasks.LoadActiveTasks(UserSession.UserId);
                        break;
                    case 3: // Devam Ediyor
                        await _activeTasks.LoadActiveTasks(UserSession.UserId);
                        break;
                    case 4: // Tamamlandı
                        await _completedTasks.LoadCompletedTasks(UserSession.UserId);
                        break;                    
                }
                await _activeTasks.LoadActiveTasks(UserSession.UserId);
                tasks = _activeTasks.GetActiveTasks();
                Grid!.SelectedItems.Clear();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result?.Response.Message ?? "Güncelleme başarısız.", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("İşlem iptal edildi.", Severity.Info);
        }
    }


    private int GetPriorityLevelFromName(string? name)
    {
        return Priorities.FirstOrDefault(p => p.Name == name)?.Level ?? 0;
    }

    private int GetStateLevelFromName(string? name)
    {
        return States.FirstOrDefault(s => s.Name == name)?.Level ?? 0;
    }
}
