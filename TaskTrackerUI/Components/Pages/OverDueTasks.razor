@page "/overduetasks"
@inject ITaskService _taskService
@inject ISnackbar Snackbar
@inject ITaskApiService _taskApiService
@inject IDialogService DialogService
@inject AppMessageState _appMessageState

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large">

        <div style="display: flex; flex-direction: column;">

            <div style="display: flex; flex-direction:column; margin-top:30px;">
                @if (!tasks.Any())
                {
                    <MudElement HtmlTag="a" Style="color:red;font-weight:bold;">Teslim tarihi geçmiş görev bulunmuyor.</MudElement>
                }
                else
                {
                    <div style="display: flex; flex-direction:row; justify-content:end">
                        <MudElement HtmlTag="a" Style="color:black;font-weight:bold;">Görevler</MudElement>
                        <MudSpacer />
                        <MudButton Color="Color.Info" Disabled="@_isUpdateDisabled" OnClick="OpenUpdateDialog">Güncelle</MudButton>
                        <MudButton Color="Color.Error" Disabled="@_isDeleteDisabled" OnClick="Delete">Sil</MudButton>
                    </div>
                    <MudDataGrid @ref="@Grid" Items="@tasks" T="TaskItemDTO" Style="margin-top: 20px; width: 100%" MultiSelection="true" ColumnResizeMode="ResizeMode.Column" SelectedItemsChanged="GridSelectionChanged">
                        <Columns>
                            <SelectColumn T="TaskItemDTO" ShowInHeader="false" />
                            <PropertyColumn Property="x => x.Title" Title="Başlık" />
                            <PropertyColumn Property="x => x.Description" Title="Açıklama" />
                            <PropertyColumn Property="x => x.PriorityName" Title="Öncelik" />
                            <PropertyColumn Property="x => x.TaskStateName" Title="Durumu" />
                            <PropertyColumn Property="x => x.DueDate" Title="Teslim Tarihi" Format="dd.MM.yyyy" />
                        </Columns>
                    </MudDataGrid>
                }
            </div>
        </div>
    </MudContainer>
}


@code {
    MudDataGrid<TaskItemDTO>? Grid;
    private IEnumerable<StateDto> States = new List<StateDto>();
    private IEnumerable<PriorityDto> Priorities = new List<PriorityDto>();
    private IEnumerable<TaskItemDTO> tasks = new List<TaskItemDTO>();
    List<Guid> selectedRowsIds = [];
    private bool _isDeleteDisabled = true;
    private bool _isUpdateDisabled = true;
    private int stateLevel = 0;
    private StateDto? selectedState { get; set; }
    private bool _isLoading = true;
    private TaskItemDTO? itemToUpdate { get; set; }
    private DateTime dateTime = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(_appMessageState.SnackbarMessage))
        {
            Snackbar.Add(_appMessageState.SnackbarMessage, _appMessageState.SnackbarSeverity);
            _appMessageState.SnackbarMessage = null;
        }
        Priorities = await _taskApiService.GetPrioritiesAsync();
        States = await _taskApiService.GetStatesAsync();
        States = States.Where(s => s.Level != 1 && s.Level != 4);
        States = States.Append(new StateDto { Level = 0, Name = "Tümü" });
        await StateSelectionChanged(0);
    }

    async Task StateSelectionChanged(int level)
    {
        _isLoading = true;
        stateLevel = level;
        selectedState = States.Where<StateDto>(s => s.Level == level).FirstOrDefault();
        if (selectedState!.Name == "Tümü")
        {
            tasks = await _taskService.GetAllActiveAsync();
        }
        else
        {
            tasks = await _taskService.GetAllActiveAsync();
            tasks = tasks.Where(t => t.TaskStateName == selectedState!.Name);
        }

        if (Grid != null)
            Grid.SelectedItems.Clear();
        selectedRowsIds.Clear();
        _isDeleteDisabled = true;
        _isLoading = false;
        StateHasChanged();
    }

    void GridSelectionChanged(HashSet<TaskItemDTO> taskItems)
    {
        selectedRowsIds.Clear();
        foreach (var item in taskItems)
        {
            selectedRowsIds.Add(item.Id);
        }
        if (taskItems.Count == 1)
        {
            itemToUpdate = taskItems.ElementAt(0);
        }
        else
        {
            itemToUpdate = null;
        }
        _isUpdateDisabled = taskItems.Count() == 1 ? false : true;
        _isDeleteDisabled = taskItems.Count() > 0 ? false : true;
        StateHasChanged();
    }

    async Task Delete()
    {
        _isUpdateDisabled = true;
        _isDeleteDisabled = true;
        if (selectedRowsIds.Count() > 0)
        {
            if (selectedRowsIds.Count() == 1)
            {
                try
                {
                    var response = await _taskService.DeleteTaskAsync(selectedRowsIds[0]);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TaskTitle} başlıklı görev silindi.", Severity.Success);
                        tasks = await _taskService.GetAllTasksAsync();
                        Grid!.SelectedItems.Clear();
                    }
                    else
                    {
                        Snackbar.Add(response.Data?.ErrorMessage ?? response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
            else
            {
                try
                {
                    var response = await _taskService.BulkDeleteAsync(selectedRowsIds);

                    if (response.Success)
                    {
                        Snackbar.Add($"{response.Data!.TotalDeleted} görev silindi.", Severity.Success);
                    }
                    else if (response.PartialSuccess)
                    {
                        string failedTitles = string.Join("\n• ", response.Data!.FailedTasks.Select(ft => ft.TaskTitle));
                        Snackbar.Add($"{response.Data.TotalDeleted} görev silindi, ancak {response.Data.FailedTasks.Count} görev silinemedi.\nSilinemeyen görevler:\n• {failedTitles}", Severity.Warning);
                    }
                    else
                    {
                        Snackbar.Add(response.Message ?? "Silme işlemi başarısız", Severity.Error);
                    }

                    if (response.Success || response.PartialSuccess)
                    {
                        tasks = await _taskService.GetAllTasksAsync();
                    }
                    Grid!.SelectedItems.Clear();
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
            }
        }
        else
        {
            Snackbar.Add("Silinecek görev seçilmedi.", Severity.Warning);
        }
        _isDeleteDisabled = false;
        _isUpdateDisabled = false;
    }

    private async Task OpenUpdateDialog()
    {
        var parameters = new DialogParameters { ["Task"] = itemToUpdate };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialogReference = await DialogService.ShowAsync<UpdateTaskDialog>("Görev Güncelle", parameters, options);
        var dialogResult = await dialogReference.Result;

        if (!dialogResult!.Canceled)
        {
            var response = dialogResult.Data as ApiResponse<OperationResult>;
            if (response?.Success == true)
            {
                Snackbar.Add("Görev başarıyla güncellendi.", Severity.Success);
                tasks = await _taskService.GetAllActiveAsync();
                Grid!.SelectedItems.Clear();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(response?.Message ?? "Güncelleme başarısız.", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("İşlem iptal edildi.", Severity.Info);
        }
    }


    private int GetPriorityLevelFromName(string? name)
    {
        return Priorities.FirstOrDefault(p => p.Name == name)?.Level ?? 0;
    }

    private int GetStateLevelFromName(string? name)
    {
        return States.FirstOrDefault(s => s.Name == name)?.Level ?? 0;
    }
}
